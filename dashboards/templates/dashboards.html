{% extends 'base.html' %}
{% load static %}

{% block dashboard-nav %}class="active"{% endblock %}

{% block body %}
  <div class="container">
    <div class="row">
      <div class="col s12">
        <h3 class="page-title">Wine Purchase Stats</h3>
      </div>
    </div>
    <div class="row dashboard-row">
      <div class="col s12 l6 xl4">
        <div class="card wine-red-card">
          <div class="card-content">
            <h2 class="card-title">Top Producers</h2>
            {% include "top_producers.html" %}
          </div>
        </div>
        <div class="card golden-yellow-card">
          <div class="card-content">
            <h2 class="card-title">Top Regions</h2>
            {% include "top_regions.html" %}
          </div>
        </div>
      </div>
      <div class="col s12 l6 xl4">
        <div class="card golden-yellow-card">
          <div class="card-content">
            <h2 class="card-title">By the Numbers</h2>
            {% include "by_the_numbers.html" %}
          </div>
        </div>
        <div class="card wine-green-card">
          <div class="card-content">
            <h2 class="card-title">Purchases by Color</h2>
            {% include "purchases_by_color.html" %}
          </div>
        </div>
        <div class="card wine-red-card card">
          <div class="card-content">
            <h2 class="card-title">Top Grape Varieties</h2>
            {% include "top_grape_varieties.html" %}
          </div>
        </div>
      </div>
      <div class="col s12 l6 xl4">
        <div class="card wine-red-card">
          <div class="card-content">
            <h2 class="card-title">Purchases by Year | Table</h2>
            {% include "purchases_by_year.html" %}
          </div>
        </div>
        <div class="card wine-green-card">
          <div class="card-content">
            <h2 class="card-title">Top Viticultural Areas</h2>
            {% include "top_viti_areas.html" %}
          </div>
        </div>
      </div>
    </div>

    {% if years|length > 1 %}
      <div class="row dashboard-row">
        <div class="col s12">
          <div class="card wine-green-card dashboard-top-card">
            <div class="card-content">
              {% if wine_count == 0 %}
                {% include "insufficient_wines.html" %}
              {% else %}
                <h2 class="card-title">Purchases by Year | Graph</h2>
                <canvas id="pb-year-chart"></canvas>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="row dashboard-row">
      <div class="col s12 xl7">
        <div class="card golden-yellow-card dashboard-top-card">
          <div class="card-content">
            <h2 class="card-title">Recent Purchases</h2>
            {% include "recent_purchases.html" %}
          </div>
        </div>
      </div>
      <div class="col s12 xl5">
        <div class="card wine-red-card dashboard-top-card">
          <div class="card-content">
            <h2 class="card-title">Top Wine Types</h2>
            {% include "top_wine_types.html" %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script type="text/javascript">
    // Colors
    const colorPurchases = {
        {% for color in colors %}
            "{{ color.name|title }}": {{ color.quantity|default_if_none:0 }},
        {% endfor %}
    };
    const colorVarieties = {
        {% for color in colors %}
            "{{ color.name|title }}": {{ color.variety|default_if_none:0 }},
        {% endfor %}
    };
    const colorPrice = {
        {% for color in colors %}
            "{{ color.name|title }}": {{ color.avg_price|default_if_none:0|floatformat:2 }},
        {% endfor %}
    };

    // Top Wine Types
    const wineTypePurchases = {
        {% for wine_type in top_wine_types %}
            "{{ wine_type.name|title }}": {{ wine_type.quantity|default_if_none:0 }},
        {% endfor %}
    };
    const wineTypeVarieties = {
        {% for wine_type in top_wine_types %}
            "{{ wine_type.name|title }}": {{ wine_type.variety|default_if_none:0 }},
        {% endfor %}
    };
    const wineTypePrice = {
        {% for wine_type in top_wine_types %}
            "{{ wine_type.name|title }}": {{ wine_type.avg_price|default_if_none:0|floatformat:2 }},
        {% endfor %}
    };

    // Top Grape Varieties
    const grapeVarieties = {
        {% for grape in grapes  %}
            "{{ grape.name }}": {{ grape.wine_varieties }},
        {% endfor %}
    };
    const grapePrice = {
        {% for grape in grapes  %}
            "{{ grape.name }}": {{ grape.avg_price|floatformat:"2" }},
        {% endfor %}
    };
    const grapePct = {
        {% for grape in grapes %}
            "{{ grape.name }}": {{ grape.avg_pct|floatformat:"1" }},
        {% endfor %}
    };

    // Top Viti Areas
    const vitiAreasVarieties = {
        {% for viti_area in viti_areas %}
            "{{ viti_area.name }}": {{ viti_area.varieties|default_if_none:0 }},
        {% endfor %}
    };
    const vitiAreasProducers = {
        {% for viti_area in viti_areas %}
            "{{ viti_area.name }}": {{ viti_area.producers }},
        {% endfor %}
    };
    const vitiAreasPrice = {
        {% for viti_area in viti_areas %}
            "{{ viti_area.name }}": {{ viti_area.avg_price|default_if_none:0 }},
        {% endfor %}
    };

    {% if years|length > 1 %}
      const doPurchasesByYear = true;
      let purchasesByYearData = [{}, {}, {}];
      {% for year in years %}
          purchasesByYearData[0][{{ year.year }}] = {{ year.quantity }};
          purchasesByYearData[1][{{ year.year }}] = {{ year.price|floatformat:2 }};
          purchasesByYearData[2][{{ year.year }}] = {{ year.avg_price|floatformat:2 }};
      {% endfor %}
    {% else %}
      const doPurchasesByYear = false;
    {% endif %}
  </script>
  <script src="{% static 'dashboards.bundle.js' %}"></script>
{% endblock %}
